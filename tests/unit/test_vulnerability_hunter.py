"""Unit tests for Vulnerability Hunter tool."""

import pytest

from reversecore_mcp.tools.malware.vulnerability_hunter import (
    VulnerabilityHunterPlugin,
    DANGEROUS_APIS,
    USER_INPUT_SOURCES,
    _get_recommendation,
    _generate_recommendations,
    _generate_yara_strings,
)


class TestDangerousAPIDatabase:
    """Tests for dangerous API database."""

    def test_critical_apis_defined(self):
        """Critical APIs should be defined."""
        critical_apis = ["strcpy", "system", "gets", "sprintf"]
        for api in critical_apis:
            assert api in DANGEROUS_APIS
            assert DANGEROUS_APIS[api]["severity"] == "critical"

    def test_api_has_required_fields(self):
        """Each API should have severity, category, description."""
        for api_name, api_info in DANGEROUS_APIS.items():
            assert "severity" in api_info, f"{api_name} missing severity"
            assert "category" in api_info, f"{api_name} missing category"
            assert "description" in api_info, f"{api_name} missing description"

    def test_severity_values_valid(self):
        """Severity should be one of critical/high/medium/low."""
        valid_severities = {"critical", "high", "medium", "low"}
        for api_name, api_info in DANGEROUS_APIS.items():
            assert api_info["severity"] in valid_severities, f"{api_name} has invalid severity"


class TestUserInputSources:
    """Tests for user input source detection."""

    def test_network_sources_included(self):
        """Network input sources should be included."""
        assert "recv" in USER_INPUT_SOURCES
        assert "recvfrom" in USER_INPUT_SOURCES

    def test_file_sources_included(self):
        """File input sources should be included."""
        assert "fread" in USER_INPUT_SOURCES
        assert "fopen" in USER_INPUT_SOURCES

    def test_environment_sources_included(self):
        """Environment input sources should be included."""
        assert "getenv" in USER_INPUT_SOURCES


class TestRecommendations:
    """Tests for recommendation generation."""

    def test_get_recommendation_buffer_overflow(self):
        """Should return appropriate recommendation for buffer overflow."""
        rec = _get_recommendation("buffer_overflow")
        assert "bounded" in rec.lower() or "strncpy" in rec.lower()

    def test_get_recommendation_command_injection(self):
        """Should return appropriate recommendation for command injection."""
        rec = _get_recommendation("command_injection")
        assert "shell" in rec.lower() or "sanitize" in rec.lower()

    def test_get_recommendation_unknown(self):
        """Should return generic recommendation for unknown category."""
        rec = _get_recommendation("unknown_category")
        assert "validate" in rec.lower() or "review" in rec.lower()

    def test_generate_recommendations_limits_to_10(self):
        """Should limit recommendations to 10."""
        vulnerabilities = [
            {"type": f"cat_{i}", "severity": "high"}
            for i in range(20)
        ]
        recs = _generate_recommendations(vulnerabilities)
        assert len(recs) <= 10


class TestYaraGeneration:
    """Tests for YARA rule generation."""

    def test_generate_yara_strings(self):
        """Should generate ASCII and wide string patterns."""
        apis = ["strcpy", "system"]
        result = _generate_yara_strings(apis)

        assert "$api0_a" in result
        assert "$api0_w" in result
        assert "strcpy" in result
        assert "ascii" in result
        assert "wide" in result

    def test_generate_yara_strings_limits(self):
        """Should limit to 10 APIs."""
        apis = [f"api_{i}" for i in range(20)]
        result = _generate_yara_strings(apis)

        # Should have max 10 * 2 = 20 patterns (ascii + wide)
        assert result.count("$api") <= 20


class TestVulnerabilityHunterPlugin:
    """Tests for plugin metadata."""

    def test_plugin_name(self):
        """Plugin should have correct name."""
        plugin = VulnerabilityHunterPlugin()
        assert plugin.name == "vulnerability_hunter"

    def test_plugin_description(self):
        """Plugin should have descriptive description."""
        plugin = VulnerabilityHunterPlugin()
        assert "vulnerability" in plugin.description.lower()
        assert "detect" in plugin.description.lower() or "discovery" in plugin.description.lower()

"""Malware analysis tools package.

Provides a unified MalwareToolsPlugin that registers all malware-related tools.
"""

from typing import Any

from reversecore_mcp.core.logging_config import get_logger
from reversecore_mcp.core.plugin import Plugin

logger = get_logger(__name__)


class MalwareToolsPlugin(Plugin):
    """Unified plugin for all malware analysis tools."""

    @property
    def name(self) -> str:
        return "malware_tools"

    @property
    def description(self) -> str:
        return "Unified malware analysis tools including detection, vaccine generation, IOC extraction, and YARA scanning."

    def register(self, mcp_server: Any) -> None:
        """Register all malware tools."""
        # Import tool functions from submodules
        from reversecore_mcp.tools.malware.dormant_detector import dormant_detector
        from reversecore_mcp.tools.malware.adaptive_vaccine import adaptive_vaccine
        from reversecore_mcp.tools.malware.vulnerability_hunter import vulnerability_hunter
        from reversecore_mcp.tools.malware.ioc_tools import extract_iocs
        from reversecore_mcp.tools.malware.yara_tools import run_yara

        # Register all tools
        mcp_server.tool(dormant_detector)
        mcp_server.tool(adaptive_vaccine)
        mcp_server.tool(vulnerability_hunter)
        mcp_server.tool(extract_iocs)
        mcp_server.tool(run_yara)

        logger.info(f"Registered {self.name} plugin with 5 malware tools (unified)")


# =============================================================================
# Backward Compatibility: Deprecated Plugin Classes
# These are kept for tests that import them directly. Use MalwareToolsPlugin instead.
# =============================================================================

class DormantDetectorPlugin(Plugin):
    """DEPRECATED: Use MalwareToolsPlugin instead."""

    @property
    def name(self) -> str:
        return "dormant_detector"

    @property
    def description(self) -> str:
        return "Hybrid reverse engineering tool (Static + Emulation) for detecting hidden malicious behaviors."

    def register(self, mcp_server: Any) -> None:
        from reversecore_mcp.tools.malware.dormant_detector import dormant_detector
        mcp_server.tool(dormant_detector)


class AdaptiveVaccinePlugin(Plugin):
    """DEPRECATED: Use MalwareToolsPlugin instead."""

    @property
    def name(self) -> str:
        return "adaptive_vaccine"

    @property
    def description(self) -> str:
        return "Automated defense generation tool (YARA rules, binary patching)."

    def register(self, mcp_server: Any) -> None:
        from reversecore_mcp.tools.malware.adaptive_vaccine import adaptive_vaccine
        mcp_server.tool(adaptive_vaccine)


class VulnerabilityHunterPlugin(Plugin):
    """DEPRECATED: Use MalwareToolsPlugin instead."""

    @property
    def name(self) -> str:
        return "vulnerability_hunter"

    @property
    def description(self) -> str:
        return "Automated vulnerability discovery combining dangerous API detection, backtrace analysis, and taint tracking"

    def register(self, mcp_server: Any) -> None:
        from reversecore_mcp.tools.malware.vulnerability_hunter import vulnerability_hunter
        mcp_server.tool(vulnerability_hunter)


# Re-export submodules for backward compatibility
from reversecore_mcp.tools.malware import dormant_detector
from reversecore_mcp.tools.malware import adaptive_vaccine
from reversecore_mcp.tools.malware import vulnerability_hunter
from reversecore_mcp.tools.malware import ioc_tools
from reversecore_mcp.tools.malware import yara_tools


__all__ = [
    "MalwareToolsPlugin",
    # Backward compatibility
    "DormantDetectorPlugin",
    "AdaptiveVaccinePlugin",
    "VulnerabilityHunterPlugin",
    # Submodules
    "dormant_detector",
    "adaptive_vaccine",
    "vulnerability_hunter",
    "ioc_tools",
    "yara_tools",
]
